# Diagnostic workflow: obtiene token (client credentials) y muestra headers+body
# para /audio-features/{id} y /tracks/{id}. Ejecutar manualmente desde Actions.
on:
  workflow_dispatch:

jobs:
  diagnostic:
    runs-on: ubuntu-latest
    steps:
      - name: Run headers/body diagnostic (single step)
        env:
          SPOTIPY_CLIENT_ID: ${{ secrets.SPOTIPY_CLIENT_ID }}
          SPOTIPY_CLIENT_SECRET: ${{ secrets.SPOTIPY_CLIENT_SECRET }}
        run: |
          set -euo pipefail

          # instalar herramientas
          sudo apt-get update -y
          sudo apt-get install -y jq curl

          # obtener token client credentials
          RESP=$(curl -s -X POST -u "${SPOTIPY_CLIENT_ID}:${SPOTIPY_CLIENT_SECRET}" -d grant_type=client_credentials https://accounts.spotify.com/api/token)
          echo "Token response keys: $(echo "$RESP" | jq -r 'keys | join(", ")')"
          ACCESS_TOKEN=$(echo "$RESP" | jq -r '.access_token // empty')
          echo "ACCESS_TOKEN length: ${#ACCESS_TOKEN}"
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "ERROR: no access_token obtained; response:"
            echo "$RESP"
            exit 1
          fi

          # ID de track para pruebas
          TRACK_ID="3AJwUDP919kvQ9QcozQPxg"

          echo
          echo "=== AUDIO-FEATURES: request and response headers/body ==="
          curl -s -D - -H "Authorization: Bearer ${ACCESS_TOKEN}" "https://api.spotify.com/v1/audio-features/${TRACK_ID}" | sed -n '1,200p'
          echo
          echo "=== TRACKS: request and response headers/body ==="
          curl -s -D - -H "Authorization: Bearer ${ACCESS_TOKEN}" "https://api.spotify.com/v1/tracks/${TRACK_ID}" | sed -n '1,200p'
