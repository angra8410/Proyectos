# Diagnostic workflow (verbose, non-failing):
# Obtiene token con Client Credentials y muestra headers+body (audio-features y tracks).
# Diseñado para no abortar en la primera respuesta 4xx/5xx y para imprimir información útil.
on:
  workflow_dispatch:

jobs:
  diagnostic:
    runs-on: ubuntu-latest
    steps:
      - name: Run headers/body diagnostic (verbose)
        env:
          SPOTIPY_CLIENT_ID: ${{ secrets.SPOTIPY_CLIENT_ID }}
          SPOTIPY_CLIENT_SECRET: ${{ secrets.SPOTIPY_CLIENT_SECRET }}
        run: |
          # keep script tolerant: do not exit on non-zero; we will inspect HTTP codes
          set -u
          echo "Installing tools..."
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq curl >/dev/null

          echo
          echo "1) Obtener token (Client Credentials)"
          RESP=$(curl -s -X POST -u "${SPOTIPY_CLIENT_ID}:${SPOTIPY_CLIENT_SECRET}" \
            -d grant_type=client_credentials https://accounts.spotify.com/api/token)
          echo "Token endpoint raw response (truncated 1000 chars):"
          echo "$RESP" | sed -n '1,100p'
          ACCESS_TOKEN=$(echo "$RESP" | jq -r '.access_token // empty' 2>/dev/null || echo "")
          echo "ACCESS_TOKEN length: ${#ACCESS_TOKEN}"
          if [ -n "$ACCESS_TOKEN" ]; then
            echo "ACCESS_TOKEN mask: ${ACCESS_TOKEN:0:4}...${ACCESS_TOKEN: -4}"
          else
            echo "WARNING: no access_token extracted from token response"
          fi

          TRACK_ID="3AJwUDP919kvQ9QcozQPxg"
          AF_URL="https://api.spotify.com/v1/audio-features/${TRACK_ID}"
          TR_URL="https://api.spotify.com/v1/tracks/${TRACK_ID}"

          echo
          echo "2) Solicitud a /audio-features (cabeceras + body)"
          # -i / -D - to include response headers; capture both headers+body
          curl -i -s -H "Authorization: Bearer ${ACCESS_TOKEN}" "${AF_URL}" | sed -n '1,300p' > /tmp/af_full.txt
          echo "---- /audio-features raw (first 300 lines) ----"
          sed -n '1,300p' /tmp/af_full.txt || true

          echo
          echo "3) Solicitud a /tracks (cabeceras + body)"
          curl -i -s -H "Authorization: Bearer ${ACCESS_TOKEN}" "${TR_URL}" | sed -n '1,300p' > /tmp/tr_full.txt
          echo "---- /tracks raw (first 300 lines) ----"
          sed -n '1,300p' /tmp/tr_full.txt || true

          echo
          echo "4) Save outputs as artifacts for download if needed"
          # create a little bundle for inspection
          mkdir -p diagnostic-output
          cp /tmp/af_full.txt diagnostic-output/audio_features_response.txt || true
          cp /tmp/tr_full.txt diagnostic-output/tracks_response.txt || true
          tar -czf diagnostic-output.tar.gz diagnostic-output || true
          echo "Diagnostic files compressed to diagnostic-output.tar.gz (attached as artifact if you add upload step)."

          # exit 0 so the step does not mark the job failed; we need the logs to inspect
          exit 0
